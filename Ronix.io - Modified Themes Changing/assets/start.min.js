const audio = document.getElementById("audio");
const input = document.querySelector('#volume');
const svg = document.querySelector('svg');
const alls = Array.from(document.querySelectorAll('.low, .medium, .high, .mute'));
let mute = false;
let lastLevel = 50;
let init = false;
let targetX = 0, targetY = 0;
let currentX = 0, currentY = 0;
let hovering = false;

function VolLevel(level) {
    if (level === 0) {
        alls[3].classList.remove('hidden');
    }
    for (let i = 0; i < level; i++) {
        alls[i].classList.remove('hidden');
    }
}

function updateVol() {
    alls.forEach(el => el.classList.add('hidden'));
    const val = input.valueAsNumber;
    const level = val >= 70 ? 3 : (val >= 30 ? 2 : (val > 0 ? 1 : 0));
    VolLevel(level);
    audio.volume = Math.min(Math.max(val / 100, 0), 1) / 2;
    lastLevel = val;
    mute = val === 0;
}

function toggleVol() {
    const interval = setInterval(() => {
        const val = input.valueAsNumber;
        if (!mute) {
            input.value = Math.max(0, val - 1);
            if (val === 0) {
                clearInterval(interval);
                mute = true;
            }
        } else {
            if (val < lastLevel) {
                input.value = Math.min(100, val + 1);
            } else {
                clearInterval(interval);
                mute = false;
            }
        }
        updateVol();
    }, 1);
}

input.addEventListener('input', updateVol);
input.addEventListener('change', updateVol);
svg.addEventListener('click', toggleVol);
updateVol();

function fadeOut(element, duration, callback) {
    element.style.transition = `opacity ${duration}ms`;
    element.style.opacity = 0;
    setTimeout(() => {
        element.style.display = "none";
        if (callback) callback();
    }, duration);
}

function fadeIn(element, duration, callback) {
    if (duration == 300) return;
    element.style.display = "block";
    element.style.opacity = 0;
    element.style.transition = `opacity ${duration}ms`;
    setTimeout(() => {
        element.style.opacity = 1;
        if (callback) callback();
    }, 10);
}

function start() {
    if (init) return;
    init = true;

    const rythm = new Rythm();
    rythm.addRythm("circlelogo", "image-shadow", 5, 15);
    rythm.addRythm("infotext", "text-shadow", 0, 10);
    rythm.addRythm("title", "text-shadow", 0, 10);
    rythm.addRythm("status", "text-shadow", 0, 10);
    rythm.addRythm("discord", "text-shadow", 0, 10);
    rythm.connectExternalAudioElement(audio);
    rythm.start();

    const clickoverlay = document.getElementById("clickoverlay");
    const panel = document.getElementById("panel");

    // Change here for any title:
    const customTitle = "BIMOLI";
    const titlecont = document.getElementById("mainTitle");
    const v3 = document.getElementById("v3Title");

    titlecont.innerHTML = "";
    v3.classList.remove("active");
    v3.style.display = "none";

    const spans = [...customTitle].map((char, i) => {
        const span = document.createElement("span");
        span.className = "letter";
        if (i === customTitle.length - 1) {
            span.id = "animatedLast";
            span.style.opacity = "0";
            span.style.transform = "translateY(-20px)";
        }
        span.textContent = "?";
        titlecont.appendChild(span);
        return { span, final: char };
    });

    let index = 0;
    const interval = setInterval(() => {
        if (index < spans.length) {
            spans[index].span.textContent = spans[index].final;
            index++;
        } else {
            clearInterval(interval);
            v3.style.display = "inline-block";
            setTimeout(() => v3.classList.add("active"), 10);
            const lastSpan = document.getElementById("animatedLast");
            lastSpan.style.transition = "transform 0.4s ease-out, opacity 0.25s ease-out";
            lastSpan.style.transform = "translateY(0)";
            lastSpan.style.opacity = "1";
        }
    }, 80);

    panel.addEventListener('mousemove', (e) => {
        const rect = panel.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        targetX = ((y - centerY) / centerY) * -25;
        targetY = ((x - centerX) / centerX) * 25;
        hovering = true;
    });

    panel.addEventListener('mouseleave', () => {
        targetX = 0;
        targetY = 0;
        hovering = false;
    });

    function animate() {
        currentX += (targetX - currentX) * 0.1;
        currentY += (targetY - currentY) * 0.1;
        panel.style.transform = `translate(-50%, -50%) rotateX(${currentX}deg) rotateY(${currentY}deg)`;
        requestAnimationFrame(animate);
    }
    animate();

    fadeOut(clickoverlay, 300, function () {
        fadeIn(panel, 300);
    });
}

setInterval(() => {
    if (init) {
        audio.play().then(start).catch(() => {});
    }
}, 50);

document.addEventListener("click", start);
particlesJS.load("particles-js", "particles.json", function () {});
